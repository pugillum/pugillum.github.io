<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>üöó Taking Prefect for a ride | Travis Dent</title>
<meta name=keywords content="orchestration"><meta name=description content="Trying out an Airflow competitor: Prefect"><meta name=author content><link rel=canonical href=https://pugillum.github.io/posts/2021_11_21_taking_prefect_for_a_ride/><link crossorigin=anonymous href=/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://pugillum.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://pugillum.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://pugillum.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://pugillum.github.io/apple-touch-icon.png><link rel=mask-icon href=https://pugillum.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://pugillum.github.io/posts/2021_11_21_taking_prefect_for_a_ride/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="üöó Taking Prefect for a ride"><meta property="og:description" content="Trying out an Airflow competitor: Prefect"><meta property="og:type" content="article"><meta property="og:url" content="https://pugillum.github.io/posts/2021_11_21_taking_prefect_for_a_ride/"><meta property="og:image" content="https://pugillum.github.io/posts/2021_11_21_taking_prefect_for_a_ride/prefect_cover.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-11-21T00:00:00+00:00"><meta property="article:modified_time" content="2021-11-21T00:00:00+00:00"><meta property="og:site_name" content="Travis Dent"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://pugillum.github.io/posts/2021_11_21_taking_prefect_for_a_ride/prefect_cover.jpg"><meta name=twitter:title content="üöó Taking Prefect for a ride"><meta name=twitter:description content="Trying out an Airflow competitor: Prefect"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://pugillum.github.io/posts/"},{"@type":"ListItem","position":2,"name":"üöó Taking Prefect for a ride","item":"https://pugillum.github.io/posts/2021_11_21_taking_prefect_for_a_ride/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"üöó Taking Prefect for a ride","name":"üöó Taking Prefect for a ride","description":"Trying out an Airflow competitor: Prefect","keywords":["orchestration"],"articleBody":" In terms of open-source workflow management tools, Apache Airflow has established itself as the de facto standard. At the time of writing this it has 1,827 contributors and 41 releases listed on its Github repo. But as is usual with software, newer implementations have arisen and one of those getting a lot of attention is Prefect. I decided to take a look and see what‚Äôs under the hood.\nThe Prefect ethos Prefect (the company) was founded in 2017. The CEO is Jeremiah Lowin and he was an Airflow core contributor.\nPrefect has an ethos centered around positive vs negative engineering: Engineers spend a significant amount of time handling the unexpected. And we like tooling that supports this with features like modularity, transparent implementations, built-in retries and mostly importantly good logging. The creators of Prefect understand this and have endeavoured to build a tool to support this.\nPrefect‚Äôs design goal is be minimally invasive when things go right and maximally helpful when go wrong. Nice.\nThe Hitchhiker‚Äôs Guide There‚Äôs also a geeky aspect to it which I enjoy which is the Hitchhiker‚Äôs Guide to the Galaxy theme. (If you haven‚Äôt read it, do, it contains one of the few famous Dents). Ford Prefect is a character in these books and though I couldn‚Äôt find any explicit reference to the book in their documentation, the fact that the search bar has a snarky Marvin and that Towel is one of the orchestrator services left me in no doubt as to the origin of the name.\nWhat about Airflow So how does it compare to Airflow? I will not be covering that in this article, they have a long, well-thought-out article in the documentation entitled ‚ÄúWhy Not Airflow?‚Äù. Any challenger to Airflow is going to have to address this question, but the Prefect folk are quite explicit about it. Perhaps in a future blog post I can do a feature-by-feature comparison.\nThe basics Here I‚Äôll run through some of the core concepts of Prefect. They have excellent documentation with many code samples. My intention here is to show the simplicity of using Prefect and to look a little deeper in terms of their implementation.\nTask from prefect import task @task def add(x,y): return x + y A Task is a discrete action in a workflow. It has an optional input and an optional result. It just requires decorating a function üéÑ. Simple.\nFlow from prefect import task, Flow import random @task def random_number(): return random.randint(0, 100) @task def add(x,y): return x + y with Flow('My Functional Flow') as flow: x = random_number() y = random_number() sum = add(x,y) flow.run() A Flow is a container for Tasks. It describes the Task dependencies. It‚Äôs a Directed Acyclic Graph (this is not surprising üòõ)\nParameter from prefect import task, Flow, Parameter @task def print_plus_one(x): print(x + 1) with Flow('Parameterized Flow') as flow: x = Parameter('x', default=2) print_plus_one(x=x) flow.run(parameters=dict(x=1)) # prints 2 flow.run(parameters=dict(x=100)) # prints 101 flow.run() # prints 3 These are special tasks that receive user input and allow defaults. This is one of the differentiators from Airflow, more here.\nSchedule A Schedule object can be attached to a flow and allows for complex scheduling configurations.\nfrom prefect import task, Flow from datetime import timedelta from prefect.schedules import IntervalSchedule @task def say_hello(): print(\"Hello, world!\") schedule = IntervalSchedule(interval=timedelta(minutes=2)) with Flow(\"Hello\", schedule) as flow: say_hello() flow.run() State This is the currency of Prefect. State objects represent information about running tasks or flows. At any moment, you can learn anything you need to know about a task or flow by examining its current state or the history of its states.\nThere are three main state types, Pending, Running and Finished. There are subclasses of these states as can be seen above. There is also MetaState which enhance existing states.\nThe documentation gives a really good coverage of states. What was most interesting for me is the ability to define state change handlers which allows for really fine grained monitoring and alerts.\nRunners and Executors This is going a bit beyond the ‚Äúbasics‚Äù but helped with understanding the underlying processing of tasks and flows\nThere are two classes, FlowRunner and TaskRunner:\nFlowRunner takes a flow and attempts to run all its tasks, followed by collecting the resulting tasks and if all are complete, returning the final state. If a task is unfinished it will loop through the tasks again and operate on them based on their states (so if a task is finished it will not be run again) FlowRunner may also receive parameter values if they have been specified TaskRunner executes a single task. It determines from the initial state and any upstream states if the task should be run. Mapping is also handled here which generate dynamic task runners. Post processing is performed to determine the need for a retry (or caching) Executors run the tasks and support submit and wait functions. Various types are supported, from a synchronous local process to a completely separate Dask engine for asynchronous processing.\nGive it a try! All of this can be setup and run with a single python package. No extra setup or dependencies.\nIf you want to give it a try:\nclone the Prefect repo from here and in the terminal open examples/tutorial install required packages including the Prefect package with pip install -r requirements.txt (preferably within a Python virtual environment) run python 02_etl_flow.py To get a feeling for the functionality I do recommend following the full tutorial.\nBut wait, there‚Äôs more! So perhaps you‚Äôre happy with a single flow running happily in a container. But you might want a few more things like:\nmanaging and visualising multiple flows a fancy UI for running and monitoring a GraphQL API for integration with other services And you can have it with Prefect Cloud or Prefect Server.\nPrefect Cloud This is a managed backend that offers the goodies above but also:\npermission and authorization management SLAs agent monitoring They support a free tier with 3 users and 10,000 runs per month. And it supports a hybrid configuration in which your data and code are kept private. The execution can be performed on agents within your own infrastructure.\nPrefect Server In many projects there‚Äôs no possibility to connect to services outside of an internal network. For this there‚Äôs Prefect Server which is an open source backend containing:\na scheduler a web server a metadata database You can run this locally with ease. If you have Docker installed you can follow the tutorial below to get a feel for the functionality supported.\nTesting out Prefect Server If you haven‚Äôt done so, install prefect with pip install prefect and clone the Prefect repo from here\nRun the following to change the backend to Prefect Server (the default is Prefect Cloud):\nprefect backend server In a terminal start the prefect server. This will spin up a number of containers\nprefect server start In another terminal start an agent.\nprefect agent local start In another terminal, create a project with\nprefect create project \"conditional\" Ensure that the project has been created by going to localhost:8080 in a browser and selecting the ‚Äúconditional‚Äù project from the dropdown\nOpen the folder examples/tutorial and register the conditionals flow with\nprefect register --project conditional --path conditional.py --name \"Example: Conditional Tasks\" You should now be able to see the flow in the project under ‚ÄúFLOWS‚Äù: select it.\nA couple of things to try out:\nRun the flow by selecting the flow and then ‚ÄúQUICK RUN‚Äù and watch the live updates. Visualise the tasks of the flow by selecting ‚ÄúTASKS‚Äù. Visualise the DAG by selecting ‚ÄúSCHEMATIC‚Äù. See the details of a specific run by selecting ‚ÄúRUNS‚Äù and selecting a run. Deployment Their deployment architecture looks as follows:\nThis allows for the use of Prefect Cloud for managing and visualising one‚Äôs flows. This would still require the provisioning of the execution environment and additional storage and monitoring. They provide guidance on agent provisioning which should cover most cloud setups.\nIf deploying to a closed environment one would then need to deploy Prefect Server. This could be deployed on a single node similarly to how it can be run locally (which uses docker-compose under the hood). A more elaborate deployment would be to a Kubernetes cluster and they provide a Helm chart to support this. It is also possible to configure use of a separate Postgres instance instead of the one running in a container, more here.\nI have unfortunately not been able to test out the deployment and will hopefully cover it in a future post.\nConnections Any decent workflow management tool should have a plethora of options for connecting to external services and Prefect is no exception. The Task Library has an overview and more details can be found by select ‚Äúprefect.tasks‚Äù in the API page.\nConclusion What I liked The minimally invasive goal: Prefect doesn‚Äôt force one to conform to use of a specific API or code style Simplicity: I could quickly grasp the base concepts The introduction tutorial: clearly explained and I could get up and running quickly The documentation in general: it‚Äôs extensive and well written What I liked less The community is still small: while searching online for details about a the Shell Task I couldn‚Äôt find many posts. This will obviously change as the adoption increases I did struggle getting Prefect Server up an running as the default is set to Cloud and I missed the command that does the switch The ETL example passes data between functions. This is good for demonstrating the data passing possibilities but I can‚Äôt foresee doing something similar for large datasets. This can, of course, be done using something like the Databricks Task or perhaps using a combination of Fivetran and DBT Overall I enjoyed working with Prefect and look forward to using it in future projects.\n","wordCount":"1636","inLanguage":"en","datePublished":"2021-11-21T00:00:00Z","dateModified":"2021-11-21T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://pugillum.github.io/posts/2021_11_21_taking_prefect_for_a_ride/"},"publisher":{"@type":"Organization","name":"Travis Dent","logo":{"@type":"ImageObject","url":"https://pugillum.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://pugillum.github.io/ accesskey=h title="  (Alt + H)"><img src=https://pugillum.github.io/avatar.png alt aria-label=logo height=35></a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://pugillum.github.io/archives/ title=archive><span>archive</span></a></li><li><a href=https://pugillum.github.io/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>üöó Taking Prefect for a ride</h1><div class=post-meta><span title='2021-11-21 00:00:00 +0000 UTC'>November 21, 2021</span>&nbsp;¬∑&nbsp;8 min</div></header><div class=post-content><p><img loading=lazy src=./prefect_cover.jpg alt></p><p>In terms of open-source workflow management tools, <a href=https://airflow.apache.org/>Apache Airflow</a> has established itself as the de facto standard. At the time of writing this it has 1,827 contributors and 41 releases listed on its Github <a href=https://github.com/apache/airflow>repo</a>. But as is usual with software, newer implementations have arisen and one of those getting a lot of attention is Prefect. I decided to take a look and see what&rsquo;s under the hood.</p><h1 id=the-prefect-ethos>The Prefect ethos<a hidden class=anchor aria-hidden=true href=#the-prefect-ethos>#</a></h1><p>Prefect (the company) was founded in 2017. The CEO is Jeremiah Lowin and he was an Airflow core contributor.</p><p>Prefect has an ethos centered around <a href=https://www.prefect.io/blog/positive-and-negative-engineering>positive vs negative engineering</a>: Engineers spend a significant amount of time handling the unexpected. And we like tooling that supports this with features like modularity, transparent implementations, built-in retries and mostly importantly good logging. The creators of Prefect understand this and have endeavoured to build a tool to support this.</p><p>Prefect&rsquo;s design goal is <em>be minimally invasive when things go right and maximally helpful when go wrong</em>. Nice.</p><h2 id=the-hitchhikers-guide>The Hitchhiker&rsquo;s Guide<a hidden class=anchor aria-hidden=true href=#the-hitchhikers-guide>#</a></h2><p><img loading=lazy src=images/index/image-20211121163048579.png alt=image-20211121163048579></p><p>There&rsquo;s also a geeky aspect to it which I enjoy which is the Hitchhiker&rsquo;s Guide to the Galaxy theme. (If you haven&rsquo;t read it, do, it contains one of the few famous Dents). Ford Prefect is a character in these books and though I couldn&rsquo;t find any explicit reference to the book in their documentation, the fact that the search bar has a snarky Marvin and that Towel is one of the orchestrator services left me in no doubt as to the origin of the name.</p><h2 id=what-about-airflow>What about Airflow<a hidden class=anchor aria-hidden=true href=#what-about-airflow>#</a></h2><p>So how does it compare to Airflow? I will not be covering that in this article, they have a long, well-thought-out article in the documentation entitled &ldquo;<a href=https://docs.prefect.io/core/about_prefect/why-not-airflow.html>Why Not Airflow?</a>&rdquo;. Any challenger to Airflow is going to have to address this question, but the Prefect folk are quite explicit about it. Perhaps in a future blog post I can do a feature-by-feature comparison.</p><h1 id=the-basics>The basics<a hidden class=anchor aria-hidden=true href=#the-basics>#</a></h1><p>Here I&rsquo;ll run through some of the core concepts of Prefect. They have excellent documentation with many code samples. My intention here is to show the simplicity of using Prefect and to look a little deeper in terms of their implementation.</p><h2 id=task>Task<a hidden class=anchor aria-hidden=true href=#task>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> prefect <span style=color:#f92672>import</span> task
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@task</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add</span>(x,y):
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> x <span style=color:#f92672>+</span> y
</span></span></code></pre></div><p>A Task is a discrete action in a workflow. It has an optional input and an optional result. It just requires decorating a function üéÑ. Simple.</p><h2 id=flow>Flow<a hidden class=anchor aria-hidden=true href=#flow>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> prefect <span style=color:#f92672>import</span> task, Flow
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> random
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@task</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>random_number</span>():
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> random<span style=color:#f92672>.</span>randint(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@task</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add</span>(x,y):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> x <span style=color:#f92672>+</span> y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> Flow(<span style=color:#e6db74>&#39;My Functional Flow&#39;</span>) <span style=color:#66d9ef>as</span> flow:
</span></span><span style=display:flex><span>    x <span style=color:#f92672>=</span> random_number()
</span></span><span style=display:flex><span>    y <span style=color:#f92672>=</span> random_number()
</span></span><span style=display:flex><span>    sum <span style=color:#f92672>=</span> add(x,y)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>flow<span style=color:#f92672>.</span>run()
</span></span></code></pre></div><p>A Flow is a container for Tasks. It describes the Task dependencies. It&rsquo;s a <a href=https://en.wikipedia.org/wiki/Directed_acyclic_graph>Directed Acyclic Graph</a> (this is <a href=https://airflow.apache.org/docs/apache-airflow/stable/concepts/dags.html>not surprising</a> üòõ)</p><h2 id=parameter>Parameter<a hidden class=anchor aria-hidden=true href=#parameter>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> prefect <span style=color:#f92672>import</span> task, Flow, Parameter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@task</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>print_plus_one</span>(x):
</span></span><span style=display:flex><span>    print(x <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> Flow(<span style=color:#e6db74>&#39;Parameterized Flow&#39;</span>) <span style=color:#66d9ef>as</span> flow:
</span></span><span style=display:flex><span>    x <span style=color:#f92672>=</span> Parameter(<span style=color:#e6db74>&#39;x&#39;</span>, default<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>    print_plus_one(x<span style=color:#f92672>=</span>x)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>flow<span style=color:#f92672>.</span>run(parameters<span style=color:#f92672>=</span>dict(x<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>))  <span style=color:#75715e># prints 2</span>
</span></span><span style=display:flex><span>flow<span style=color:#f92672>.</span>run(parameters<span style=color:#f92672>=</span>dict(x<span style=color:#f92672>=</span><span style=color:#ae81ff>100</span>))  <span style=color:#75715e># prints 101</span>
</span></span><span style=display:flex><span>flow<span style=color:#f92672>.</span>run()  <span style=color:#75715e># prints 3</span>
</span></span></code></pre></div><p>These are special tasks that receive user input and allow defaults. This is one of the differentiators from Airflow, more <a href=https://docs.prefect.io/core/about_prefect/why-not-airflow.html#parametrized-workflows>here</a>.</p><h2 id=schedule>Schedule<a hidden class=anchor aria-hidden=true href=#schedule>#</a></h2><p>A Schedule object can be attached to a flow and allows for complex scheduling configurations.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> prefect <span style=color:#f92672>import</span> task, Flow
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> datetime <span style=color:#f92672>import</span> timedelta
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> prefect.schedules <span style=color:#f92672>import</span> IntervalSchedule
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@task</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>say_hello</span>():
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;Hello, world!&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>schedule <span style=color:#f92672>=</span> IntervalSchedule(interval<span style=color:#f92672>=</span>timedelta(minutes<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> Flow(<span style=color:#e6db74>&#34;Hello&#34;</span>, schedule) <span style=color:#66d9ef>as</span> flow:
</span></span><span style=display:flex><span>    say_hello()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>flow<span style=color:#f92672>.</span>run()
</span></span></code></pre></div><h2 id=state>State<a hidden class=anchor aria-hidden=true href=#state>#</a></h2><p>This is the <strong>currency</strong> of Prefect. State objects represent information about running tasks or flows. At any moment, you can learn anything you need to know about a task or flow by examining its current state or the history of its states.</p><p><img loading=lazy src=images/index/image-20211121165958805.png alt=image-20211121165958805></p><p>There are three main state types, <code>Pending</code>, <code>Running</code> and <code>Finished</code>. There are subclasses of these states as can be seen above. There is also <code>MetaState</code> which enhance existing states.</p><p>The <a href=https://docs.prefect.io/core/concepts/states.html#overview>documentation</a> gives a really good coverage of states. What was most interesting for me is the ability to define state change handlers which allows for really fine grained monitoring and alerts.</p><h2 id=runners-and-executors>Runners and Executors<a hidden class=anchor aria-hidden=true href=#runners-and-executors>#</a></h2><p>This is going a bit beyond the &ldquo;basics&rdquo; but helped with understanding the underlying processing of tasks and flows</p><p><img loading=lazy src=images/index/image-20211123210612080.png alt=image-20211123210612080></p><p>There are two classes, FlowRunner and TaskRunner:</p><ul><li>FlowRunner takes a flow and attempts to run all its tasks, followed by collecting the resulting tasks and if all are complete, returning the final state. If a task is unfinished it will loop through the tasks again and operate on them based on their states (so if a task is finished it will not be run again)</li><li>FlowRunner may also receive parameter values if they have been specified</li><li>TaskRunner executes a single task. It determines from the initial state and any upstream states if the task should be run. <a href=https://docs.prefect.io/core/concepts/mapping.html>Mapping</a> is also handled here which generate dynamic task runners. Post processing is performed to determine the need for a retry (or <a href=https://docs.prefect.io/core/concepts/persistence.html>caching</a>)</li></ul><p>Executors run the tasks and support <code>submit</code> and <code>wait</code> functions. Various types are supported, from a synchronous local process to a completely separate <a href=https://docs.dask.org/en/stable/>Dask</a> engine for asynchronous processing.</p><h2 id=give-it-a-try>Give it a try!<a hidden class=anchor aria-hidden=true href=#give-it-a-try>#</a></h2><p>All of this can be setup and run with a single python package. No extra setup or dependencies.</p><p>If you want to give it a try:</p><ul><li>clone the Prefect repo from <a href=https://github.com/PrefectHQ/prefect>here</a> and in the terminal open <code>examples/tutorial</code></li><li>install required packages including the Prefect <a href=https://pypi.org/project/prefect/>package</a> with <code>pip install -r requirements.txt</code> (preferably within a Python <a href=https://docs.python.org/3/tutorial/venv.html>virtual environment</a>)</li><li>run <code>python 02_etl_flow.py</code></li></ul><p>To get a feeling for the functionality I do recommend following the <a href=https://docs.prefect.io/core/tutorial/01-etl-before-prefect.html>full tutorial</a>.</p><h1 id=but-wait-theres-more>But wait, there&rsquo;s more!<a hidden class=anchor aria-hidden=true href=#but-wait-theres-more>#</a></h1><p>So perhaps you&rsquo;re happy with a single flow running happily in a container. But you might want a few more things like:</p><ul><li>managing and visualising multiple flows</li><li>a fancy UI for running and monitoring</li><li>a GraphQL API for integration with other services</li></ul><p>And you can have it with Prefect Cloud or Prefect Server.</p><h2 id=prefect-cloud>Prefect Cloud<a hidden class=anchor aria-hidden=true href=#prefect-cloud>#</a></h2><p>This is a managed backend that offers the goodies above but also:</p><ul><li>permission and authorization management</li><li>SLAs</li><li>agent monitoring</li></ul><p>They support a free tier with 3 users and 10,000 runs per month. And it supports a <a href=https://docs.prefect.io/orchestration/#architecture-overview>hybrid configuratio</a>n in which your data and code are kept private. The execution can be performed on agents within your own infrastructure.</p><h2 id=prefect-server>Prefect Server<a hidden class=anchor aria-hidden=true href=#prefect-server>#</a></h2><p>In many projects there&rsquo;s no possibility to connect to services outside of an internal network. For this there&rsquo;s Prefect Server which is an open source backend containing:</p><ul><li>a scheduler</li><li>a web server</li><li>a metadata database</li></ul><p>You can run this locally with ease. If you have Docker installed you can follow the tutorial below to get a feel for the functionality supported.</p><h2 id=testing-out-prefect-server>Testing out Prefect Server<a hidden class=anchor aria-hidden=true href=#testing-out-prefect-server>#</a></h2><ol><li><p>If you haven&rsquo;t done so, install prefect with <code>pip install prefect</code> and clone the Prefect repo from <a href=https://github.com/PrefectHQ/prefect>here</a></p></li><li><p>Run the following to change the backend to Prefect Server (the default is Prefect Cloud):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>prefect backend server
</span></span></code></pre></div></li><li><p>In a terminal start the prefect server. This will spin up a number of containers</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>prefect server start
</span></span></code></pre></div></li><li><p>In another terminal start an agent.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>prefect agent local start
</span></span></code></pre></div></li><li><p>In another terminal, create a project with</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>prefect create project <span style=color:#e6db74>&#34;conditional&#34;</span>
</span></span></code></pre></div></li><li><p>Ensure that the project has been created by going to <code>localhost:8080</code> in a browser and selecting the &ldquo;conditional&rdquo; project from the dropdown</p><p><img loading=lazy src=images/index/image-20211228172821389.png alt=image-20211228172821389></p></li><li><p>Open the folder <code>examples/tutorial</code> and register the conditionals flow with</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>prefect register --project conditional --path conditional.py --name <span style=color:#e6db74>&#34;Example: Conditional Tasks&#34;</span>
</span></span></code></pre></div></li><li><p>You should now be able to see the flow in the project under &ldquo;FLOWS&rdquo;: select it.</p></li><li><p>A couple of things to try out:</p><ul><li>Run the flow by selecting the flow and then &ldquo;QUICK RUN&rdquo; and watch the live updates.</li><li>Visualise the tasks of the flow by selecting &ldquo;TASKS&rdquo;.</li><li>Visualise the DAG by selecting &ldquo;SCHEMATIC&rdquo;.</li><li>See the details of a specific run by selecting &ldquo;RUNS&rdquo; and selecting a run.</li></ul></li></ol><p><img loading=lazy src=images/index/image-20211228182308660.png alt=image-20211228182308660></p><h1 id=deployment>Deployment<a hidden class=anchor aria-hidden=true href=#deployment>#</a></h1><p>Their deployment architecture looks as follows:</p><p><img loading=lazy src=https://docs.prefect.io/prefect_architecture_overview.png alt></p><p>This allows for the use of Prefect Cloud for managing and visualising one&rsquo;s flows. This would still require the provisioning of the execution environment and additional storage and monitoring. They provide <a href=https://docs.prefect.io/orchestration/agents/overview.html#agent-types>guidance</a> on agent provisioning which should cover most cloud setups.</p><p>If deploying to a closed environment one would then need to deploy Prefect Server. This could be deployed on a single node similarly to how it can be run locally (which uses <code>docker-compose</code> under the hood). A more elaborate deployment would be to a Kubernetes cluster and they provide a <a href=https://github.com/PrefectHQ/server/tree/master/helm/prefect-server>Helm chart</a> to support this. It is also possible to configure use of a separate Postgres instance instead of the one running in a container, more <a href=https://docs.prefect.io/orchestration/server/deploy-local.html#external-postgres-instance>here</a>.</p><blockquote><p>I have unfortunately not been able to test out the deployment and will hopefully cover it in a future post.</p></blockquote><h1 id=connections>Connections<a hidden class=anchor aria-hidden=true href=#connections>#</a></h1><p>Any decent workflow management tool should have a plethora of options for connecting to external services and Prefect is no exception. The <a href=https://docs.prefect.io/api/latest/#task-library>Task Library</a> has an overview and more details can be found by select &ldquo;prefect.tasks&rdquo; in the <a href=https://docs.prefect.io/api/latest/>API page</a>.</p><h1 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h1><h2 id=what-i-liked>What I liked<a hidden class=anchor aria-hidden=true href=#what-i-liked>#</a></h2><ul><li>The minimally invasive goal: Prefect doesn&rsquo;t force one to conform to use of a specific API or code style</li><li>Simplicity: I could quickly grasp the base concepts</li><li>The introduction tutorial: clearly explained and I could get up and running quickly</li><li>The documentation in general: it&rsquo;s extensive and well written</li></ul><h2 id=what-i-liked-less>What I liked less<a hidden class=anchor aria-hidden=true href=#what-i-liked-less>#</a></h2><ul><li>The community is still small: while searching online for details about a the <a href=https://docs.prefect.io/api/latest/tasks/shell.html#shelltask>Shell Task</a> I couldn&rsquo;t find many posts. This will obviously change as the adoption increases</li><li>I did struggle getting Prefect Server up an running as the default is set to Cloud and I missed the command that does the switch</li><li>The ETL example passes data between functions. This is good for demonstrating the data passing possibilities but I can&rsquo;t foresee doing something similar for large datasets. This can, of course, be done using something like the <a href=https://docs.prefect.io/api/latest/tasks/databricks.html#databrickssubmitrun>Databricks Task</a> or perhaps using a combination of <a href=https://docs.prefect.io/api/latest/tasks/fivetran.html>Fivetran</a> and <a href=https://docs.prefect.io/api/latest/tasks/dbt.html>DBT</a></li></ul><p>Overall I enjoyed working with Prefect and look forward to using it in future projects.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://pugillum.github.io/tags/orchestration/>Orchestration</a></li></ul><nav class=paginav><a class=prev href=https://pugillum.github.io/posts/2021_11_28_github_issues_as_comments/><span class=title>¬´ Prev</span><br><span>üí¨ Add comments to your Hugo blog linked to Github issues with utterances</span>
</a><a class=next href=https://pugillum.github.io/posts/2021_08_03_how_to_move_azure_devops_wiki/><span class=title>Next ¬ª</span><br><span>‚û°Ô∏è Move Azure DevOps project wiki to a standard repo</span></a></nav></footer><script src=https://utteranc.es/client.js repo=pugillum/pugillum.github.io issue-term=pathname label=blog theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2025 <a href=https://pugillum.github.io/>Travis Dent</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>