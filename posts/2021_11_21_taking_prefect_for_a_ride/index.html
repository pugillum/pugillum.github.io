<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Taking Prefect for a ride | Travis Dent</title>
<meta name=keywords content="orchestration">
<meta name=description content="Trying out an Airflow competitor: Prefect">
<meta name=author content>
<link rel=canonical href=https://pugillum.github.io/posts/2021_11_21_taking_prefect_for_a_ride/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.79b192cca391a0913ddae67d992782c0fdb84632da097ee44bd026ffe4e6997e.css integrity="sha256-ebGSzKORoJE92uZ9mSeCwP24RjLaCX7kS9Am/+TmmX4=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://pugillum.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://pugillum.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://pugillum.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://pugillum.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://pugillum.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.91.2">
<meta property="og:title" content="Taking Prefect for a ride">
<meta property="og:description" content="Trying out an Airflow competitor: Prefect">
<meta property="og:type" content="article">
<meta property="og:url" content="https://pugillum.github.io/posts/2021_11_21_taking_prefect_for_a_ride/">
<meta property="og:image" content="https://pugillum.github.io/prefect_cover.jpg"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-11-21T00:00:00+00:00">
<meta property="article:modified_time" content="2021-11-21T00:00:00+00:00"><meta property="og:site_name" content="Travis Dent">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://pugillum.github.io/prefect_cover.jpg">
<meta name=twitter:title content="Taking Prefect for a ride">
<meta name=twitter:description content="Trying out an Airflow competitor: Prefect">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://pugillum.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Taking Prefect for a ride","item":"https://pugillum.github.io/posts/2021_11_21_taking_prefect_for_a_ride/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Taking Prefect for a ride","name":"Taking Prefect for a ride","description":"Trying out an Airflow competitor: Prefect","keywords":["orchestration"],"articleBody":"In terms of open-source workflow management tools, Apache Airflow has established itself as the de facto standard. At the time of writing this it has 1,827 contributors and 41 releases listed on its Github repo. But as is usual with software, newer implementations have arisen and one of these is Prefect. I decided to take a look and see what‚Äôs under the hood. Should you migrate your Airflow project to Prefect? What are the benefits? What are the risks?\nSome history and ethos Prefect (the company) was founded in 2017. The CEO is Jeremiah Lowin and he was an Airflow core contributor.\nPrefect has an ethos centered around positive vs negative engineering. I like this. On most of the data engineering projects I‚Äôve worked on, a lot of time is spent on solving or mitigating things that go wrong. Yet a lot of modern tooling (especially vendor specific frameworks) get built around the assumption that things will just work. And then when they go wrong one wastes days trying to figure out what actually happened and a few more days trying to make sure it doesn‚Äôt happen again.\nPrefect‚Äôs design goal is be minimally invasive when things go right and maximally helpful when go wrong. Nice.\nThere‚Äôs also a geeky aspect to it which I enjoy which is the Hitchhiker‚Äôs Guide to the Galaxy. (If you haven‚Äôt read it, do, it contains one of the few famous Dents). Ford Prefect is a character in these books and though I couldn‚Äôt find any explicit reference to the book in their documentation, the fact that the search bar has a snarky Marvin and that Towel is one of the orchestrator services left me in no doubt as to the origin of the name.\nFinally - Airflow. They have a long, well-thought-out article in the documentation entitled ‚ÄúWhy Not Airflow?‚Äù. Now any challenger to Airflow is going to have to address this question, but the Prefect folk are quite explicit about it. More on this later.\nThe basics Task from prefect import task @task def add(x,y): return x + y A Task is a discrete action in a workflow. It has an optional input and an optional result. It just requires decorating a function üéÑ. Simple.\nFlow from prefect import task, Flow import random @task def random_number(): return random.randint(0, 100) @task def add(x,y): return x + y with Flow('My Functional Flow') as flow: x = random_number() y = random_number() sum = add(x,y) flow.run() A Flow is a container for Tasks. It describes the Task dependencies. It‚Äôs a Directed Acyclic Graph (this is not surprising üòõ)\nParameter from prefect import task, Flow, Parameter @task def print_plus_one(x): print(x + 1) with Flow('Parameterized Flow') as flow: x = Parameter('x', default=2) print_plus_one(x=x) flow.run(parameters=dict(x=1)) # prints 2 flow.run(parameters=dict(x=100)) # prints 101 flow.run() # prints 3 These are special tasks that receive user input and allow defaults. This is one of the differentiators from Airflow, more here.\nSchedule A Schedule object can be attached to a flow and allows for complex scheduling configurations.\nfrom prefect import task, Flow from datetime import timedelta from prefect.schedules import IntervalSchedule @task def say_hello(): print(\"Hello, world!\") schedule = IntervalSchedule(interval=timedelta(minutes=2)) with Flow(\"Hello\", schedule) as flow: say_hello() flow.run() State This is the currency of Prefect. State objects represent information about running tasks or flows. At any moment, you can learn anything you need to know about a task or flow by examining its current state or the history of its states.\nThere are three main state types, Pending, Running and Finished. There are subclasses of these states as can be seen above. There is also MetaState which enhance existing states.\nThe documentation gives a really good coverage of states. What was most interesting for me is the ability to define state change handlers which allows for really fine grained monitoring and alerts.\nRunners and Executors This is going a bit beyond the ‚Äúbasics‚Äù but helped with understanding the underlying processing of tasks and flows\nThere are two classes, FlowRunner and TaskRunner:\n FlowRunner takes a flow and attempts to run all its tasks, followed by collecting the resulting tasks and if all are complete, returning the final state. If a task is unfinished it will loop through the tasks again and operate on them based on their states (so if a task is finished it will not be run again) FlowRunner may also receive parameter values if those have been specified TaskRunner executes a single task. It determies from the initial state and any upstream states if the task should be run. Mapping is also handled here which generate dynamic task runners. Post processing is performed to determine the need for a retry (or caching)  Executors run the tasks and support submit and wait functions. Various types are supported, from a synchronous local process to a completely separate Dask engine for asynchronous processing.\nIt runs locally ü•≥ All of this can be setup and run with a single python package. No extra setup or dependencies.\nIf you want to give it a try:\n clone the Prefect repo from here and in the terminal open examples/tutorial install required packages including the Prefect package with pip install -r requirements.txt (preferably within a Python virtual environment) Run python 02_etl_flow.py  To get a feeling for the functionality I do recommend following the full tutorial.\nBut wait, there‚Äôs more! So perhaps you‚Äôre happy with a single flow running happily in a container. But you might want a few more things like:\n managing and visualising multiple flows a fancy UI for running and monitoring a GraphQL API for integration with other services  And you can have it with Prefect Cloud or Prefect Server.\nPrefect Cloud This is a managed backend that offers the goodies above but also:\n permission and authorization management SLAs Agent monitoring  They support a free tier with 3 users and 10,000 runs per month. And it supports a hybrid configuration in which your data and code are kept private. The execution can be performed on agents within your own infrastructure.\nPrefect Server In many projects there‚Äôs no possibility to connect to services outside of an internal network. For this there‚Äôs Prefect Server and provided you have Docker installed, you can test it out locally:\n  If you haven‚Äôt done so, install prefect with pip install prefect and clone the Prefect repo from here\n  Run prefect backend server to change the backend to Prefect Server (the default is Prefect Cloud)\n  In a terminal start the prefect server. This will spin up a number of containers\nprefect server start   In another terminal start an agent.\nprefect agent local start   In another terminal, create a project with\nprefect create project \"conditional\"   Ensure that the project has been created by going to localhost:8080 in a browser and selecting the ‚Äúconditional‚Äù project from the dropdown\n  Open the folder examples/tutorial and register the conditionals flow with\nprefect register --project conditional --path conditional.py --name \"Example: Conditional Tasks\"   You should now be able to see the flow in the project under ‚ÄúFLOWS‚Äù: select it.\n  A couple of things to try out:\n  Run the flow by selecting the flow and then ‚ÄúQUICK RUN‚Äù and watch the live updates\n  Visualise the tasks of the flow by selecting ‚ÄúTASKS‚Äù\n  Visualise the DAG by selecting ‚ÄúSCHEMATIC‚Äù\n  See the details of a specific run by selecting ‚ÄúRUNS‚Äù and selecting a run\n    Deployment Prefect also provides documentation on deployment of both server and agents in Kubernetes\nAirflow So as mentioned near the start, Prefect has lengthy justification for the use of their tool over Airflow. Here are the key points:\n  scheduler isn‚Äôt central and doesn‚Äôt check tasks\n  workflows can be parameterized\n  scheduling is less weird\n  functional API vs Airflow‚Äôs imperative class-based approach (though this is different with the new Task API)\n  workflows are standalone, decoupled from scheduler\n  Prefect flow schedules own tasks\n  No XCom for data exchange between tasks\n  Prefect supports parameterized workflows\n  Prefect does dynamic workflows well\n  Local testing requires no scheduler\n  Conclusion So should I migrate my existing Airflow setup to Prefect?\nAirflow has been around for a good long while and has a large community and a huge number of operators for integration with various services. It has some flaws but these flaws are well known and can be mitigated by proper configuration and use. It is also being actively developed (for instance, from version 2.0.0, dag and task decorators were introduced)\nThat said, legacy systems can sometimes be hamstrung by a core architecture developed for a different age. I wouldn‚Äôt advise necessarily migrating from an existing Airflow setup, but if you‚Äôre starting from scratch and your orchestration needs are fairly limited, give Prefect a look.\n","wordCount":"1434","inLanguage":"en","image":"https://pugillum.github.io/prefect_cover.jpg","datePublished":"2021-11-21T00:00:00Z","dateModified":"2021-11-21T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://pugillum.github.io/posts/2021_11_21_taking_prefect_for_a_ride/"},"publisher":{"@type":"Organization","name":"Travis Dent","logo":{"@type":"ImageObject","url":"https://pugillum.github.io/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<noscript>
<style type=text/css>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://pugillum.github.io/ accesskey=h title="  (Alt + H)">
<img src=/avatar.png alt=logo aria-label=logo height=35> </a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu onscroll=menu_on_scroll()>
<li>
<a href=https://pugillum.github.io/archives/ title=archive>
<span>archive</span>
</a>
</li>
<li>
<a href=https://pugillum.github.io/tags/ title=tags>
<span>tags</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
Taking Prefect for a ride
</h1>
<div class=post-meta>November 21, 2021&nbsp;¬∑&nbsp;7 min
</div>
</header>
<figure class=entry-cover>
<img loading=lazy srcset="https://pugillum.github.io/posts/2021_11_21_taking_prefect_for_a_ride/prefect_cover_huecab7c2945b270321fc76a29eedcdc7b_49783_360x0_resize_q75_box.jpg 360w ,https://pugillum.github.io/posts/2021_11_21_taking_prefect_for_a_ride/prefect_cover_huecab7c2945b270321fc76a29eedcdc7b_49783_480x0_resize_q75_box.jpg 480w ,https://pugillum.github.io/posts/2021_11_21_taking_prefect_for_a_ride/prefect_cover.jpg 512w" sizes="(min-width: 768px) 720px, 100vw" src=https://pugillum.github.io/posts/2021_11_21_taking_prefect_for_a_ride/prefect_cover.jpg alt="Prefect named after Ford Prefect named after the Ford Prefect">
<p>Prefect named after Ford Prefect who named himself after the Ford Prefect</p>
</figure>
<div class=post-content><p>In terms of open-source workflow management tools, <a href=https://airflow.apache.org/>Apache Airflow</a> has established itself as the de facto standard. At the time of writing this it has 1,827 contributors and 41 releases listed on its Github <a href=https://github.com/apache/airflow>repo</a>. But as is usual with software, newer implementations have arisen and one of these is Prefect. I decided to take a look and see what&rsquo;s under the hood. Should you migrate your Airflow project to Prefect? What are the benefits? What are the risks?</p>
<h1 id=some-history-and-ethos>Some history and ethos<a hidden class=anchor aria-hidden=true href=#some-history-and-ethos>#</a></h1>
<p>Prefect (the company) was founded in 2017. The CEO is Jeremiah Lowin and he was an Airflow core contributor.</p>
<p>Prefect has an ethos centered around <a href=https://www.prefect.io/blog/positive-and-negative-engineering>positive vs negative engineering</a>. I like this. On most of the data engineering projects I&rsquo;ve worked on, a lot of time is spent on solving or mitigating things that go wrong. Yet a lot of modern tooling (especially vendor specific frameworks) get built around the assumption that things will just work. And then when they go wrong one wastes days trying to figure out what actually happened and a few more days trying to make sure it doesn&rsquo;t happen again.</p>
<p>Prefect&rsquo;s design goal is <em>be minimally invasive when things go right and maximally helpful when go wrong</em>. Nice.</p>
<p><img loading=lazy src=images/index/image-20211121163048579.png alt=image-20211121163048579>
</p>
<p>There&rsquo;s also a geeky aspect to it which I enjoy which is the Hitchhiker&rsquo;s Guide to the Galaxy. (If you haven&rsquo;t read it, do, it contains one of the few famous Dents). Ford Prefect is a character in these books and though I couldn&rsquo;t find any explicit reference to the book in their documentation, the fact that the search bar has a snarky Marvin and that Towel is one of the orchestrator services left me in no doubt as to the origin of the name.</p>
<p>Finally - Airflow. They have a long, well-thought-out article in the documentation entitled &ldquo;<a href=https://docs.prefect.io/core/about_prefect/why-not-airflow.html>Why Not Airflow?</a>&rdquo;. Now any challenger to Airflow is going to have to address this question, but the Prefect folk are quite explicit about it. More on this later.</p>
<h1 id=the-basics>The basics<a hidden class=anchor aria-hidden=true href=#the-basics>#</a></h1>
<h2 id=task>Task<a hidden class=anchor aria-hidden=true href=#task>#</a></h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> prefect <span style=color:#f92672>import</span> task

<span style=color:#a6e22e>@task</span>
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add</span>(x,y):
	<span style=color:#66d9ef>return</span> x <span style=color:#f92672>+</span> y
</code></pre></div><p>A Task is a discrete action in a workflow. It has an optional input and an optional result. It just requires decorating a function üéÑ. Simple.</p>
<h2 id=flow>Flow<a hidden class=anchor aria-hidden=true href=#flow>#</a></h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> prefect <span style=color:#f92672>import</span> task, Flow
<span style=color:#f92672>import</span> random

<span style=color:#a6e22e>@task</span>
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>random_number</span>():
    <span style=color:#66d9ef>return</span> random<span style=color:#f92672>.</span>randint(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>100</span>)

<span style=color:#a6e22e>@task</span>
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add</span>(x,y):
    <span style=color:#66d9ef>return</span> x <span style=color:#f92672>+</span> y

<span style=color:#66d9ef>with</span> Flow(<span style=color:#e6db74>&#39;My Functional Flow&#39;</span>) <span style=color:#66d9ef>as</span> flow:
    x <span style=color:#f92672>=</span> random_number()
    y <span style=color:#f92672>=</span> random_number()
    sum <span style=color:#f92672>=</span> add(x,y)

flow<span style=color:#f92672>.</span>run()
</code></pre></div><p>A Flow is a container for Tasks. It describes the Task dependencies. It&rsquo;s a <a href=https://en.wikipedia.org/wiki/Directed_acyclic_graph>Directed Acyclic Graph</a> (this is <a href=https://airflow.apache.org/docs/apache-airflow/stable/concepts/dags.html>not surprising</a> üòõ)</p>
<h2 id=parameter>Parameter<a hidden class=anchor aria-hidden=true href=#parameter>#</a></h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> prefect <span style=color:#f92672>import</span> task, Flow, Parameter

<span style=color:#a6e22e>@task</span>
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>print_plus_one</span>(x):
    print(x <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)

<span style=color:#66d9ef>with</span> Flow(<span style=color:#e6db74>&#39;Parameterized Flow&#39;</span>) <span style=color:#66d9ef>as</span> flow:
    x <span style=color:#f92672>=</span> Parameter(<span style=color:#e6db74>&#39;x&#39;</span>, default<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>)
    print_plus_one(x<span style=color:#f92672>=</span>x)

flow<span style=color:#f92672>.</span>run(parameters<span style=color:#f92672>=</span>dict(x<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>))  <span style=color:#75715e># prints 2</span>
flow<span style=color:#f92672>.</span>run(parameters<span style=color:#f92672>=</span>dict(x<span style=color:#f92672>=</span><span style=color:#ae81ff>100</span>))  <span style=color:#75715e># prints 101</span>
flow<span style=color:#f92672>.</span>run()  <span style=color:#75715e># prints 3</span>
</code></pre></div><p>These are special tasks that receive user input and allow defaults. This is one of the differentiators from Airflow, more <a href=https://docs.prefect.io/core/about_prefect/why-not-airflow.html#parametrized-workflows>here</a>.</p>
<h2 id=schedule>Schedule<a hidden class=anchor aria-hidden=true href=#schedule>#</a></h2>
<p>A Schedule object can be attached to a flow and allows for complex scheduling configurations.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> prefect <span style=color:#f92672>import</span> task, Flow
<span style=color:#f92672>from</span> datetime <span style=color:#f92672>import</span> timedelta
<span style=color:#f92672>from</span> prefect.schedules <span style=color:#f92672>import</span> IntervalSchedule

<span style=color:#a6e22e>@task</span>
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>say_hello</span>():
    print(<span style=color:#e6db74>&#34;Hello, world!&#34;</span>)

schedule <span style=color:#f92672>=</span> IntervalSchedule(interval<span style=color:#f92672>=</span>timedelta(minutes<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>))

<span style=color:#66d9ef>with</span> Flow(<span style=color:#e6db74>&#34;Hello&#34;</span>, schedule) <span style=color:#66d9ef>as</span> flow:
    say_hello()

flow<span style=color:#f92672>.</span>run()

</code></pre></div><h2 id=state>State<a hidden class=anchor aria-hidden=true href=#state>#</a></h2>
<p>This is the <strong>currency</strong> of Prefect. State objects represent information about running tasks or flows. At any moment, you can learn anything you need to know about a task or flow by examining its current state or the history of its states.</p>
<p><img loading=lazy src=images/index/image-20211121165958805.png alt=image-20211121165958805>
</p>
<p>There are three main state types, <code>Pending</code>, <code>Running</code> and <code>Finished</code>. There are subclasses of these states as can be seen above. There is also <code>MetaState</code> which enhance existing states.</p>
<p>The <a href=https://docs.prefect.io/core/concepts/states.html#overview>documentation</a> gives a really good coverage of states. What was most interesting for me is the ability to define state change handlers which allows for really fine grained monitoring and alerts.</p>
<h2 id=runners-and-executors>Runners and Executors<a hidden class=anchor aria-hidden=true href=#runners-and-executors>#</a></h2>
<p>This is going a bit beyond the &ldquo;basics&rdquo; but helped with understanding the underlying processing of tasks and flows</p>
<p><img loading=lazy src=images/index/image-20211123210612080.png alt=image-20211123210612080>
</p>
<p>There are two classes, FlowRunner and TaskRunner:</p>
<ul>
<li>FlowRunner takes a flow and attempts to run all its tasks, followed by collecting the resulting tasks and if all are complete, returning the final state. If a task is unfinished it will loop through the tasks again and operate on them based on their states (so if a task is finished it will not be run again)</li>
<li>FlowRunner may also receive parameter values if those have been specified</li>
<li>TaskRunner executes a single task. It determies from the initial state and any upstream states if the task should be run. <a href=https://docs.prefect.io/core/concepts/mapping.html>Mapping</a> is also handled here which generate dynamic task runners. Post processing is performed to determine the need for a retry (or <a href=https://docs.prefect.io/core/concepts/persistence.html>caching</a>)</li>
</ul>
<p>Executors run the tasks and support <code>submit</code> and <code>wait</code> functions. Various types are supported, from a synchronous local process to a completely separate Dask engine for asynchronous processing.</p>
<h2 id=it-runs-locally->It runs locally ü•≥<a hidden class=anchor aria-hidden=true href=#it-runs-locally->#</a></h2>
<p>All of this can be setup and run with a single python package. No extra setup or dependencies.</p>
<p>If you want to give it a try:</p>
<ul>
<li>clone the Prefect repo from <a href=https://github.com/PrefectHQ/prefect>here</a> and in the terminal open <code>examples/tutorial</code></li>
<li>install required packages including the Prefect <a href=https://pypi.org/project/prefect/>package</a> with <code>pip install -r requirements.txt</code> (preferably within a Python <a href=https://docs.python.org/3/tutorial/venv.html>virtual environment</a>)</li>
<li>Run <code>python 02_etl_flow.py</code></li>
</ul>
<p>To get a feeling for the functionality I do recommend following the <a href=https://docs.prefect.io/core/tutorial/01-etl-before-prefect.html>full tutorial</a>.</p>
<h1 id=but-wait-theres-more>But wait, there&rsquo;s more!<a hidden class=anchor aria-hidden=true href=#but-wait-theres-more>#</a></h1>
<p>So perhaps you&rsquo;re happy with a single flow running happily in a container. But you might want a few more things like:</p>
<ul>
<li>managing and visualising multiple flows</li>
<li>a fancy UI for running and monitoring</li>
<li>a GraphQL API for integration with other services</li>
</ul>
<p>And you can have it with Prefect Cloud or Prefect Server.</p>
<h2 id=prefect-cloud>Prefect Cloud<a hidden class=anchor aria-hidden=true href=#prefect-cloud>#</a></h2>
<p>This is a managed backend that offers the goodies above but also:</p>
<ul>
<li>permission and authorization management</li>
<li>SLAs</li>
<li>Agent monitoring</li>
</ul>
<p>They support a free tier with 3 users and 10,000 runs per month. And it supports a <a href=https://docs.prefect.io/orchestration/#architecture-overview>hybrid configuratio</a>n in which your data and code are kept private. The execution can be performed on agents within your own infrastructure.</p>
<h2 id=prefect-server>Prefect Server<a hidden class=anchor aria-hidden=true href=#prefect-server>#</a></h2>
<p>In many projects there&rsquo;s no possibility to connect to services outside of an internal network. For this there&rsquo;s Prefect Server and provided you have Docker installed, you can test it out locally:</p>
<ol>
<li>
<p>If you haven&rsquo;t done so, install prefect with <code>pip install prefect</code> and clone the Prefect repo from <a href=https://github.com/PrefectHQ/prefect>here</a></p>
</li>
<li>
<p>Run <code>prefect backend server</code> to change the backend to Prefect Server (the default is Prefect Cloud)</p>
</li>
<li>
<p>In a terminal start the prefect server. This will spin up a number of containers</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>prefect server start
</code></pre></div></li>
<li>
<p>In another terminal start an agent.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>prefect agent local start
</code></pre></div></li>
<li>
<p>In another terminal, create a project with</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>prefect create project <span style=color:#e6db74>&#34;conditional&#34;</span>
</code></pre></div></li>
<li>
<p>Ensure that the project has been created by going to <code>localhost:8080</code> in a browser and selecting the &ldquo;conditional&rdquo; project from the dropdown</p>
<p><img loading=lazy src=images/index/image-20211228172821389.png alt=image-20211228172821389>
</p>
</li>
<li>
<p>Open the folder <code>examples/tutorial</code> and register the conditionals flow with</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>prefect register --project conditional --path conditional.py --name <span style=color:#e6db74>&#34;Example: Conditional Tasks&#34;</span>
</code></pre></div></li>
<li>
<p>You should now be able to see the flow in the project under &ldquo;FLOWS&rdquo;: select it.</p>
</li>
<li>
<p>A couple of things to try out:</p>
<ul>
<li>
<p>Run the flow by selecting the flow and then &ldquo;QUICK RUN&rdquo; and watch the live updates</p>
</li>
<li>
<p>Visualise the tasks of the flow by selecting &ldquo;TASKS&rdquo;</p>
</li>
<li>
<p>Visualise the DAG by selecting &ldquo;SCHEMATIC&rdquo;</p>
</li>
<li>
<p>See the details of a specific run by selecting &ldquo;RUNS&rdquo; and selecting a run</p>
</li>
</ul>
</li>
</ol>
<h2 id=deployment>Deployment<a hidden class=anchor aria-hidden=true href=#deployment>#</a></h2>
<p>Prefect also provides documentation on deployment of both server and agents in Kubernetes</p>
<h1 id=airflow>Airflow<a hidden class=anchor aria-hidden=true href=#airflow>#</a></h1>
<p>So as mentioned near the start, Prefect has lengthy justification for the use of their tool over Airflow. Here are the key points:</p>
<ul>
<li>
<p>scheduler isn&rsquo;t central and doesn&rsquo;t check tasks</p>
</li>
<li>
<p>workflows can be parameterized</p>
</li>
<li>
<p>scheduling is less weird</p>
</li>
<li>
<p>functional API vs Airflow&rsquo;s imperative class-based approach (though this is different with the new Task API)</p>
</li>
<li>
<p>workflows are standalone, decoupled from scheduler</p>
</li>
<li>
<p>Prefect flow schedules own tasks</p>
</li>
<li>
<p>No XCom for data exchange between tasks</p>
</li>
<li>
<p>Prefect supports parameterized workflows</p>
</li>
<li>
<p>Prefect does dynamic workflows well</p>
</li>
<li>
<p>Local testing requires no scheduler</p>
</li>
</ul>
<h1 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h1>
<p>So should I migrate my existing Airflow setup to Prefect?</p>
<p>Airflow has been around for a good long while and has a large community and a huge number of operators for integration with various services. It has some flaws but these flaws are well known and can be mitigated by proper configuration and use. It is also being actively developed (for instance, from version 2.0.0, dag and task decorators were <a href=https://airflow.apache.org/docs/apache-airflow/2.0.0/concepts.html#taskflow-api>introduced</a>)</p>
<p>That said, legacy systems can sometimes be hamstrung by a core architecture developed for a different age. I wouldn&rsquo;t advise necessarily migrating from an existing Airflow setup, but if you&rsquo;re starting from scratch and your orchestration needs are fairly limited, give Prefect a look.</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://pugillum.github.io/tags/orchestration/>orchestration</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://pugillum.github.io/posts/2021_11_28_drawio_in_markdown/>
<span class=title>¬´ Prev Page</span>
<br>
<span>All you need for your documentation is VS Code, Markdown and draw.io</span>
</a>
<a class=next href=https://pugillum.github.io/posts/2021_08_03_how_to_move_azure_devops_wiki/>
<span class=title>Next Page ¬ª</span>
<br>
<span>Move Azure DevOps project wiki to a standard repo</span>
</a>
</nav>
</footer><script src=https://utteranc.es/client.js repo=pugillum/pugillum.github.io issue-term=pathname label=blog theme=github-light crossorigin=anonymous async></script>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://pugillum.github.io/>Travis Dent</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)">
<button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</button>
</a>
<script>window.onload=function(){localStorage.getItem("menu-scroll-position")&&(document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position"))};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft)}document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>